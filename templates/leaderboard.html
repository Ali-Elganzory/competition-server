<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flower Competition Leaderboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

    {% macro render_leaderboard_table(data, track_name) %}
    <table class="table table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th scope="col">Rank</th>
                <th scope="col">Team</th>
                <th scope="col">Best Score (%)</th>
                <th scope="col">Revision</th>
                <th scope="col">Timestamp</th>
                <th scope="col">All Submissions</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in data %}
            <tr class="fw-bold">

                <td>
                    {% if loop.index == 1 %}
                    <span class="badge rounded-pill bg-warning text-dark fs-6 p-2" style="min-width: 35px;">ü•á</span>
                    {% elif loop.index == 2 %}
                    <span class="badge rounded-pill bg-secondary text-white fs-6 p-2" style="min-width: 35px;">ü•à</span>
                    {% elif loop.index == 3 %}
                    <span class="badge rounded-pill text-white fs-6 p-2"
                        style="background-color: #b08d57; min-width: 35px;">ü•â</span>
                    {% else %}
                    <span class="badge rounded-pill bg-light text-dark fs-6 p-2" style="min-width: 40px;">{{ loop.index
                        }}</span>
                    {% endif %}
                </td>
                <td>{{ entry.team }}</td>
                <td>{{ "%.2f"|format(entry.best_score) }}</td>
                <td><code title="{{ entry.best_revision }}">{{ entry.best_revision[:8] }}</code></td>
                <td>{{ entry.best_timestamp }}</td>
                <td>
                    {% if entry.all_submissions and entry.all_submissions|length > 1 %}
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                        data-bs-target="#details-{{ track_name }}-{{ loop.index0 }}">
                        Show ({{ entry.all_submissions|length }})
                    </button>
                    {% elif entry.all_submissions and entry.all_submissions|length == 1 %}
                    <span class="text-muted">1</span>
                    {% else %}
                    <span class="text-muted">None</span>
                    {% endif %}
                </td>
            </tr>

            {% if entry.all_submissions and entry.all_submissions|length > 1 %}
            <tr class="collapse" id="details-{{ track_name }}-{{ loop.index0 }}">
                <td colspan="6" class="bg-light">
                    <div class="p-3">
                        <h6 class="mb-3">All Submissions for {{ entry.team }}</h6>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Score</th>
                                    <th>Revision</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sub in entry.all_submissions %}
                                <tr>
                                    <td>{{ "%.2f"|format(sub.score) }}</td>
                                    <td><code title="{{ sub.revision }}">{{ sub.revision[:8] }}</code></td>
                                    <td>{{ sub.timestamp }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
            {% endif %}
            {% else %}
            <tr>
                <td colspan="6" class="text-center text-muted">No submissions for this track yet.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endmacro %}


    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h1 class="mb-0">Flower Classification Leaderboard</h1>
            {% if deadline %}
            <div class="text-end">
                <div class="fw-bold text-danger" id="countdown"
                    style="font-size: 1.5rem; line-height: 1.2; min-height: 1.5rem;">--</div>
                <small class="text-muted d-block">Deadline</small>
            </div>
            {% endif %}
        </div>
        <p class="text-muted mb-4"><em>Note: These results are preliminary.</em></p>

        <ul class="nav nav-tabs" id="trackTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="fast-tab" data-bs-toggle="tab" data-bs-target="#fast-track-pane"
                    type="button" role="tab">
                    üöÄ Fast Models (< 100K) </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="large-tab" data-bs-toggle="tab" data-bs-target="#large-track-pane"
                    type="button" role="tab">
                    üêò Large Models (< 25M) </button>
            </li>
        </ul>

        <div class="tab-content" id="trackTabsContent">

            <div class="tab-pane fade show active" id="fast-track-pane" role="tabpanel">
                <div class="table-responsive mt-3">
                    {{ render_leaderboard_table(leaderboards.fast, 'fast') }}
                </div>
            </div>

            <div class="tab-pane fade" id="large-track-pane" role="tabpanel">
                <div class="table-responsive mt-3">
                    {{ render_leaderboard_table(leaderboards.large, 'large') }}
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    {% if deadline %}
    <script>
        // Set the deadline date
        const deadlineDate = new Date("{{ deadline }}");

        function updateCountdown() {
            const now = new Date().getTime();
            const distance = deadlineDate.getTime() - now;

            if (distance < 0) {
                document.getElementById("countdown").innerHTML = "Deadline Passed";
                document.getElementById("countdown").className = "fw-bold text-secondary";
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            let countdownText = "";
            if (days > 0) {
                countdownText = `${days}d ${hours}h ${minutes}m ${seconds}s`;
            } else if (hours > 0) {
                countdownText = `${hours}h ${minutes}m ${seconds}s`;
            } else if (minutes > 0) {
                countdownText = `${minutes}m ${seconds}s`;
            } else {
                countdownText = `${seconds}s`;
            }

            document.getElementById("countdown").innerHTML = countdownText;
        }

        // Update countdown immediately and then every second
        updateCountdown();
        setInterval(updateCountdown, 1000);
    </script>
    {% endif %}

</body>

</html>